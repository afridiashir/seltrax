generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String          @id @default(uuid())
  name      String
  email     String          @unique
  password  String
  createdAt DateTime        @default(now())
  stores    UserStoreRole[] // Relation to stores via roles
}

model Store {
  id             String           @id @default(uuid())
  ownerId        String
  name           String
  category       String?
  logoUrl        String?
  siteIcon       String?
  mainDomain     String?
  currency       String           @default("Rs")
  createdAt      DateTime         @default(now())
  users          UserStoreRole[] // Relation to users via roles
  customers      Customer[]
  domains        Domain[]
  shippingRate   ShippingRate[]
  taxRules       TaxRules[]
  paymentGateway PaymentGateway[]
  coupons        Coupons[]
  collections    Collection[]
  media          Media[]
  subscriptions  Subscription[]
  products       Product[]
}

model UserStoreRole {
  id      String @id @default(uuid())
  userId  String
  storeId String
  role    Role

  user  User  @relation(fields: [userId], references: [id])
  store Store @relation(fields: [storeId], references: [id])

  @@unique([userId, storeId]) // a user can have only one role per store
}

enum Role {
  OWNER
  ADMIN
  STAFF
}

// Customers

model Customer {
  id             String   @id @default(uuid())
  storeId        String
  firstName      String
  lastName       String
  email          String
  phone          String?
  address        String?
  state          String?
  city           String?
  country        String?
  zipCode        String?
  emailMarketing Boolean? @default(false)
  smsMarketing   Boolean? @default(false)
  note           String?
  createdAt      DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id])

  @@unique([storeId, phone])
}

// Domains

model Domain {
  id          String       @id @default(uuid())
  storeId     String
  domain      String       @unique
  isPrimary   Boolean      @default(false)
  status      DomainStatus @default(PENDING) // e.g., pending, verified
  lastChecked DateTime?
  createdAt   DateTime     @default(now())

  store Store @relation(fields: [storeId], references: [id])
}

enum DomainStatus {
  PENDING
  VERIFIED
  ACTIVE
  FAILED
}

// Shipping Options 

model ShippingRate {
  id      String @id @default(uuid())
  storeId String

  name  String
  price Float // price for this rate (0 if free)

  minOrderPrice Float? // e.g., free above 5000
  maxOrderPrice Float? // optional

  minWeight Float? // for weight-based shipping (optional)
  maxWeight Float? // optional

  estimatedDeliveryDays Int? // optional

  createdAt DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id])
}

// Tax Rules 

model TaxRules {
  id          String   @id @default(uuid())
  storeId     String
  name        String
  percentage  Float?
  fixedAmount Float?
  createdAt   DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id])
}

// PaymentGateway 

model PaymentGateway {
  id          String   @id @default(uuid())
  storeId     String
  name        String
  description String?
  details     Json?
  createdAt   DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id])
}

// Coupons or Discount Codes 

model Coupons {
  id            String     @id @default(uuid())
  storeId       String
  code          String     @unique
  discount      Float // e.g., percentage or fixed amount
  type          CouponType // e.g., percentage, fixed
  minOrderValue Float? // minimum order value to apply coupon
  maxDiscount   Float? // maximum discount limit
  startDate     DateTime?
  endDate       DateTime?
  usageLimit    Int? // maximum times this coupon can be used
  usedCount     Int        @default(0) // how many times this coupon has been used
  isActive      Boolean    @default(true) // whether the coupon is active

  createdAt DateTime @default(now())
  store     Store    @relation(fields: [storeId], references: [id])

  @@unique([storeId, code])
}

enum CouponType {
  PERCENTAGE
  FIXED
}

// Collection or Categories 

model Collection {
  id             String  @id @default(uuid())
  storeId        String
  name           String
  description    String?
  slug           String  @unique
  imageUrl       String?
  headerImageUrl String?

  // SEO fields
  seoTitle       String?
  seoDescription String?
  seoKeywords    String?

  // Parentâ€“child hierarchy
  parentId String?
  parent   Collection?  @relation("CollectionHierarchy", fields: [parentId], references: [id])
  children Collection[] @relation("CollectionHierarchy")

  createdAt DateTime @default(now())

  store Store @relation(fields: [storeId], references: [id])

  @@unique([storeId, slug])
}

// Plan & Subscription Models 

model Plan {
  id        String       @id @default(uuid())
  name      String
  price     Float
  currency  String
  interval  PlanInterval
  createdAt DateTime     @default(now())

  subscriptions Subscription[]
}

model Subscription {
  id        String             @id @default(uuid())
  storeId   String
  planId    String
  status    SubscriptionStatus
  startDate DateTime
  endDate   DateTime?
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  store Store @relation(fields: [storeId], references: [id])
  plan  Plan  @relation(fields: [planId], references: [id])

  @@index([storeId])
  @@index([planId])
}

enum PlanInterval {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  CANCELED
  EXPIRED
  PAUSED
}

// Media && MediaRelation Models 

model Media {
  id        String   @id @default(uuid())
  storeId   String
  url       String
  type      String
  mimeType  String
  size      Int
  altText   String?
  createdAt DateTime @default(now())

  store         Store           @relation(fields: [storeId], references: [id])
  MediaRelation MediaRelation[]
}

model MediaRelation {
  id         String          @id @default(uuid())
  mediaId    String
  entityId   String
  entityType MediaEntityType
  sortOrder  Int?
  createdAt  DateTime        @default(now())

  media Media @relation(fields: [mediaId], references: [id])

  @@index([entityType, entityId])
}

enum MediaEntityType {
  PRODUCT
  VARIANT
}

// Product & its Relations 

model Product {
  id          String        @id @default(uuid())
  storeId     String
  title       String
  description String?
  slug        String
  price       Float
  salePrice   Float?
  mainImage   String?
  status      ProductStatus
  createdAt   DateTime      @default(now())

  store    Store            @relation(fields: [storeId], references: [id])
  options  ProductOption[]
  variants ProductVariant[]

  @@unique([storeId, slug])
  @@index([storeId])
}

model ProductOption {
  id        String @id @default(uuid())
  productId String
  name      String
  sortOrder Int

  product               Product                @relation(fields: [productId], references: [id])
  values                ProductOptionValue[]
  productVariantOptions ProductVariantOption[]

  @@unique([productId, name])
}

model ProductOptionValue {
  id        String @id @default(uuid())
  optionId  String
  value     String
  sortOrder Int

  option                ProductOption          @relation(fields: [optionId], references: [id])
  productVariantOptions ProductVariantOption[]

  @@unique([optionId, value])
}

model ProductVariant {
  id        String   @id @default(uuid())
  productId String
  sku       String   @unique
  barcode   String?
  price     Float
  salePrice Float?
  stock     Int
  createdAt DateTime @default(now())

  product Product                @relation(fields: [productId], references: [id])
  options ProductVariantOption[]

  @@index([productId])
}

model ProductVariantOption {
  id        String @id @default(uuid())
  variantId String
  optionId  String
  valueId   String

  variant ProductVariant     @relation(fields: [variantId], references: [id])
  option  ProductOption      @relation(fields: [optionId], references: [id])
  value   ProductOptionValue @relation(fields: [valueId], references: [id])

  @@unique([variantId, optionId])
}

enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}
